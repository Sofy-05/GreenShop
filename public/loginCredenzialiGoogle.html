<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login WebApp</title>
    <link rel="stylesheet" href="style.css">

    <script src="https://accounts.google.com/gsi/client" async></script>
</head>
<body>
    <div class="login-container">
        <h2>Login</h2>

        <form id="loginForm">
            <div>
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div>
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit">Login</button>
        </form>
        
        <hr style="margin: 20px 0;">
        
        <div
            id="g_id_onload"
            data-client_id="572583154622-9rm3eevp9dkhgjuui52ua9rir3k5ng4n.apps.googleusercontent.com"
            data-callback="handleCredentialResponse"
            data-auto_prompt="false"
        ></div>
        
        <div class="g_id_signin" 
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="sign_in_with"
             data-shape="rectangular"
             data-logo_alignment="left">
        </div>
        
        <p id="message"></p>
    </div>

    <script>
        // Funzione per la decodifica del JWT (per visualizzare i dati nel browser)
        // Nota: questa decodifica Ã¨ solo per DEBUG; la VERIFICA deve avvenire sul server!
        function decodeJWT(token) {
            let base64Url = token.split(".")[1];
            let base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
            let jsonPayload = decodeURIComponent(
                atob(base64)
                    .split("")
                    .map(function (c) {
                        return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
                    })
                    .join("")
            );
            return JSON.parse(jsonPayload);
        }

        // Funzione di Callback chiamata da Google dopo l'accesso
        function handleCredentialResponse(response) {
            const id_token = response.credential;
            console.log("Encoded JWT ID token: " + id_token);

            // QUI DEVI INVIARE L'ID TOKEN AL TUO SERVER BACKEND!
            
            // Esempio di invio con fetch:
            fetch('/api/google-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ token: id_token })
            })
            .then(res => res.json())
            .then(data => {
                console.log("Risposta del server:", data);
                // Reindirizza l'utente se l'accesso ha avuto successo
                // window.location.href = "/dashboard";
            })
            .catch(error => {
                console.error('Errore nell\'invio del token:', error);
            });


            // Esempio di decodifica solo per log di debug (opzionale)
            const responsePayload = decodeJWT(id_token);
            console.log("Decoded Payload:", responsePayload);
            document.getElementById('message').innerText = 
                'Accesso Google Riuscito! Ciao, ' + responsePayload.name + 
                '. Token inviato al server.';
        }
    </script>
    
    <script src="login.js"></script>
</body>
</html>